# User Story 4.1.7 — Technical Analysis (Levels 1–4)

## US 4.1.7  
**As a Logistics Operator, I want to create a Vessel Visit Execution (VVE) record when a vessel arrives at the port, so that the actual start of operations can be logged and monitored.**

---

## 1. Architectural Vision and Responsibility (WHY)

### Objective and Value
User Story 4.1.7 enables the **transition from planning to execution** by creating a Vessel Visit Execution (VVE) record when a vessel physically arrives at the port. This functionality:
- Marks the beginning of real-time operational tracking;
- Links planned operations to actual execution;
- Provides a foundation for monitoring progress and performance;
- Enables comparison between planned vs. actual timelines;
- Supports operational decision-making and resource management.

The VVE serves as the **aggregate root** for all execution-related data, including:
- Actual timestamps (arrival, berthing, unberthing, departure)
- Executed operations with resource usage
- Linked incidents and complementary tasks
- Operational status (IN_PROGRESS, COMPLETED, DISRUPTED)

### Role in the System
This User Story is a **critical transition point** in the operational workflow:

**Planning Phase** (US 4.1.2):
1. Operation plan is generated with PlannedOperations
2. Plan is reviewed and approved by operator

**Execution Phase** (US 4.1.7 → 4.1.11):
3. **Vessel arrives** → VVE is created (US 4.1.7) with status IN_PROGRESS
4. Berthing recorded → Dock assignment confirmed (US 4.1.8)
5. Operations executed → Progress tracked in real-time (US 4.1.9)
6. Unberthing and departure → VVE marked as COMPLETED (US 4.1.11)

### Architectural Principles Applied
- **Aggregate Root Pattern**: VVE is the entry point for all execution-related operations
- **Lifecycle Management**: VVE has a well-defined state machine (PLANNED → IN_PROGRESS → COMPLETED)
- **Immutable Identifiers**: VVE ID follows sequential pattern (VVE-000001, VVE-000002, ...)
- **Derived from Plan**: ExecutedOperations are initialized from PlannedOperations in the approved plan
- **Auditability**: Creation timestamp and user ID are recorded
- **Idempotency**: Cannot create duplicate VVE for the same VVN

---

## 2. Functional Analysis and Business Rules (WHAT)

### Functional Description
When a vessel physically arrives at the port, the logistics operator initiates VVE creation by providing:
- **Operation Plan ID**: Reference to the approved operation plan
- **VVN ID**: Vessel Visit Notification identifier (from Core Backend)
- **Arrival Time**: Actual timestamp when vessel arrived at port

The system performs the following:
1. **Validate operation plan**: Ensure plan exists and has status APPROVED
2. **Check for duplicate VVE**: Prevent multiple VVEs for the same VVN
3. **Extract planned operations**: Filter operations for the specific VVN from the plan
4. **Generate VVE ID**: Create sequential business identifier (VVE-000001, VVE-000002, ...)
5. **Initialize ExecutedOperations**: Derive from PlannedOperations with initial status STARTED
6. **Create VVE entity**: Instantiate with status IN_PROGRESS
7. **Update plan status**: Mark operation plan as IN_EXECUTION
8. **Save to database**: Persist VVE record in MongoDB
9. **Return VVE data**: Send created VVE to SPA for display

### Business Rules Implemented

#### VVE Creation Rules
1. **Operation plan must be APPROVED** before VVE can be created
2. **Only one VVE per VVN** (uniqueness constraint enforced)
3. **VVE ID is auto-generated** following sequential pattern (VVE-000001, VVE-000002, ...)
4. **Initial status is IN_PROGRESS** (vessel is now at port, operations can begin)
5. **Actual arrival time is required** (cannot be null)
6. **VVN must have operations in the plan** (at least one PlannedOperation)

#### ExecutedOperation Initialization (US 4.1.9 Integration)
When a VVE is created, **ExecutedOperations are derived from PlannedOperations**:
- **Operation type**: Copied from PlannedOperation (LOADING, UNLOADING, BOTH)
- **Start time**: Initially set to `plannedStart` (will be updated when operation actually starts)
- **Containers processed**: Initialized to 0 (not yet processed)
- **Cranes used**: Copied from `assignedCranes` in plan
- **Staff assigned**: Copied from `assignedStaff` in plan
- **Status**: Set to STARTED (ready to begin)
- **Planned operation ID**: Link to original PlannedOperation for traceability

This approach ensures that:
- Operators don't need to manually enter operations
- Planned resources are pre-assigned
- Deviations from plan can be tracked (actual vs. planned)
- Operations can be updated as execution progresses

#### VVE Identifier Pattern
The VVE ID follows a **sequential business identifier** pattern:
- Format: `VVE-NNNNNN` (e.g., VVE-000001, VVE-000002, ...)
- Generated by `VveIdGenerator.generate(sequentialNumber)`
- Sequential number obtained from repository: `getNextSequentialNumber()`
- Ensures human-readable, predictable identifiers
- Simplifies auditing and communication

#### Operation Plan Status Update
When VVE is created, the operation plan transitions from APPROVED to IN_EXECUTION:
- Method: `operationPlan.startExecution()`
- Indicates that at least one vessel has started operations
- Plan remains in IN_EXECUTION until all VVEs are completed
- Audit log entry is added to track the transition

### Typical Use Cases
- **Vessel arrival**: Create VVE when vessel reaches port entrance
- **Early/late arrival**: Record actual arrival time (may differ from ETA)
- **Resume after delay**: Track actual start of operations after weather delay
- **Multiple vessels**: Create VVEs for multiple vessels arriving on same day

### Exceptional Scenarios
- **Plan not approved**: VVE creation blocked (422 error)
- **Plan not found**: Operation plan ID invalid (404 error)
- **Duplicate VVE**: VVE already exists for VVN (409 error)
- **No operations for VVN**: Plan doesn't include the specified VVN (404 error)
- **Invalid arrival time**: Future arrival time or invalid format (400 error)
- **Unauthorized user**: Missing or invalid JWT token (401 error)

---

## 3. Technical and Structural Analysis (HOW)

### REST API Endpoint

**Initialize VVE from Operation Plan**
- **Method**: `POST`
- **Path**: `/api/v1/vessel-visit-executions/initialize`
- **Authentication**: Required (JWT token)
- **Authorization**: Logistics Operator role

**Request Body**:
```json
{
  "operationPlanId": "674f9c8e1234567890abcdef",
  "vvnId": "2025-PTLEI-000001",
  "arrivalTime": "2025-12-15T08:15:00Z"
}
```

**Response (201 Created)**:
```json
{
  "success": true,
  "message": "Vessel visit execution initialized successfully",
  "data": {
    "vveId": "VVE-000001",
    "vvnId": "2025-PTLEI-000001",
    "operationPlanId": "674f9c8e1234567890abcdef",
    "status": "IN_PROGRESS",
    "actualPortArrivalTime": "2025-12-15T08:15:00Z",
    "operations": [
      {
        "operationType": "LOADING",
        "startTime": "2025-12-15T09:00:00Z",
        "containersProcessed": 0,
        "cranesUsed": ["CRANE-01", "CRANE-02"],
        "staffAssigned": ["STAFF-101", "STAFF-102"],
        "status": "STARTED",
        "plannedOperationId": "674f9c8e-2025-PTLEI-000001-LOADING-0"
      }
    ],
    "createdAt": "2025-12-15T08:15:00Z"
  }
}
```

**Error Responses**:
- **400 Bad Request**: Invalid input (missing fields, invalid UUID, invalid date format)
- **401 Unauthorized**: Missing or invalid JWT token
- **404 Not Found**: Operation plan not found or no operations for VVN
- **409 Conflict**: VVE already exists for this VVN
- **422 Unprocessable Entity**: Operation plan not approved
- **500 Internal Server Error**: Database error or unexpected failure

### Component Responsibilities

#### Presentation Layer
**VesselVisitExecutionController** (`src/presentation/controllers/VesselVisitExecutionController.ts`):

**Method**: `initializeFromPlan(req, res, next)`

**Responsibilities**:
- Extract request body: `operationPlanId`, `vvnId`, `arrivalTime`
- Retrieve user from JWT: `req.user.sub` (user ID)
- Validate user authentication (401 if missing)
- Delegate to service: `vveService.initializeVveFromPlan()`
- Return 201 status with VVE data

**Route Definition** (`src/presentation/routes/vesselVisitExecution.routes.ts`):
- Path: `/initialize`
- Method: POST
- Middleware: `authMiddleware`
- Validation:
  - `operationPlanId`: required, must be valid UUID v4
  - `vvnId`: required, non-empty string
  - `arrivalTime`: required, ISO 8601 date-time format

#### Application Layer
**VesselVisitExecutionService** (`src/application/services/VesselVisitExecutionService.ts`):

**Method**: `initializeVveFromPlan(dto: InitializeVveFromPlanDto)`

**Input DTO**:
```typescript
interface InitializeVveFromPlanDto {
  operationPlanId: string;
  vvnId: string;
  arrivalTime: string; // ISO 8601
  createdBy: string; // User ID from JWT
}
```

**Implementation Steps**:

1. **Fetch operation plan**:
   ```typescript
   const operationPlan = await this.operationPlanRepository.findById(dto.operationPlanId);
   if (!operationPlan) throw new Error('Operation plan not found');
   ```

2. **Verify plan status**:
   ```typescript
   if (operationPlan.status !== 'APPROVED') {
     throw new Error('Operation plan must be APPROVED');
   }
   ```

3. **Filter operations for VVN**:
   ```typescript
   const plannedOperationsForVvn = operationPlan.operations.filter(
     op => op.vvnId === dto.vvnId
   );
   if (plannedOperationsForVvn.length === 0) {
     throw new Error('No planned operations found for VVN');
   }
   ```

4. **Check for duplicate VVE**:
   ```typescript
   const existingVve = await this.vveRepository.findByVvnId(dto.vvnId);
   if (existingVve) {
     throw new Error('VVE already exists for vessel visit');
   }
   ```

5. **Generate VVE ID**:
   ```typescript
   const nextSequentialNumber = await this.vveRepository.getNextSequentialNumber();
   const vveId = VveIdGenerator.generate(nextSequentialNumber);
   // Result: "VVE-000001", "VVE-000002", etc.
   ```

6. **Create ExecutedOperations from PlannedOperations**:
   ```typescript
   const executedOperations = plannedOperationsForVvn.map((plannedOp, index) => {
     const plannedOperationId = `${dto.operationPlanId}-${dto.vvnId}-${plannedOp.operationType}-${index}`;
     
     return new ExecutedOperation({
       operationType: plannedOp.operationType,
       startTime: plannedOp.plannedStart, // Initially set to planned time
       containersProcessed: 0,
       cranesUsed: plannedOp.assignedCranes,
       staffAssigned: plannedOp.assignedStaff || [],
       status: ExecutedOperationStatus.STARTED,
       plannedOperationId // Link to planned operation
     });
   });
   ```

7. **Create VVE entity**:
   ```typescript
   const vve = new VesselVisitExecution({
     vveId, // Sequential business ID
     vvnId: dto.vvnId,
     operationPlanId: dto.operationPlanId,
     actualPortArrivalTime: new Date(dto.arrivalTime),
     operations: executedOperations,
     status: VesselVisitExecutionStatus.IN_PROGRESS
   });
   ```

8. **Save VVE**:
   ```typescript
   const saved = await this.vveRepository.save(vve);
   ```

9. **Update operation plan status**:
   ```typescript
   operationPlan.startExecution(); // Transitions to IN_EXECUTION
   await this.operationPlanRepository.update(operationPlan);
   ```

10. **Log and return**:
    ```typescript
    logger.info(`VVE ${saved.vveId} initialized for VVN ${dto.vvnId}`);
    return this.toDto(saved);
    ```

#### Domain Layer
**VesselVisitExecution Entity** (`src/domain/entities/VesselVisitExecution.ts`):

**Constructor**:
```typescript
constructor(props: {
  vveId?: string;
  vvnId: string;
  operationPlanId?: string;
  actualPortArrivalTime?: Date;
  operations?: ExecutedOperation[];
  status?: VesselVisitExecutionStatus;
  // ... other fields
})
```

**Validations**:
- `vvnId` is required and non-empty
- Timestamp sequence is validated (berth after arrival, unberth after berth, etc.)
- Operations array is copied (not referenced)
- Default status is PLANNED (but IN_PROGRESS when created via US 4.1.7)

**Properties**:
- `vveId`: string (VVE-NNNNNN pattern)
- `vvnId`: string (reference to VVN in Core Backend)
- `operationPlanId`: string (reference to operation plan)
- `actualPortArrivalTime`: Date
- `actualBerthTime`: Date (set later in US 4.1.8)
- `actualUnberthTime`: Date (set later in US 4.1.11)
- `actualPortDepartureTime`: Date (set later in US 4.1.11)
- `assignedDock`: string (set in US 4.1.8)
- `operations`: ExecutedOperation[] (initialized from plan)
- `status`: VesselVisitExecutionStatus (IN_PROGRESS)
- `incidents`: string[] (incident IDs)

**ExecutedOperation Value Object** (`src/domain/value-objects/ExecutedOperation.ts`):
```typescript
class ExecutedOperation {
  operationType: OperationType;
  startTime: Date;
  endTime?: Date;
  containersProcessed: number;
  cranesUsed: string[];
  staffAssigned: string[];
  status: ExecutedOperationStatus; // STARTED, IN_PROGRESS, COMPLETED
  plannedOperationId: string; // US 4.1.9: Link to PlannedOperation
}
```

**VveIdGenerator Domain Service** (`src/domain/services/VveIdGenerator.ts`):
```typescript
class VveIdGenerator {
  static generate(sequentialNumber: number): string {
    const paddedNumber = sequentialNumber.toString().padStart(6, '0');
    return `VVE-${paddedNumber}`;
  }
}
```

#### Infrastructure Layer
**VesselVisitExecutionRepository** (`src/infrastructure/repositories/VesselVisitExecutionRepository.ts`):

**Key Methods**:
- `save(vve: VesselVisitExecution): Promise<VesselVisitExecution>`
  - Converts domain entity to MongoDB document
  - Uses `insertOne()` for new records
  - Returns saved entity

- `findByVvnId(vvnId: string): Promise<VesselVisitExecution | null>`
  - Queries by `vvnId` field
  - Returns null if not found
  - Used for duplicate detection

- `getNextSequentialNumber(): Promise<number>`
  - Counts existing VVEs
  - Returns `count + 1`
  - Thread-safe with MongoDB atomic operations

**MongoDB Schema**:
```javascript
{
  _id: ObjectId,
  vveId: "VVE-000001",
  vvnId: "2025-PTLEI-000001",
  operationPlanId: "674f9c8e1234567890abcdef",
  status: "IN_PROGRESS",
  actualPortArrivalTime: ISODate("2025-12-15T08:15:00Z"),
  actualBerthTime: null,
  actualUnberthTime: null,
  actualPortDepartureTime: null,
  assignedDock: null,
  operations: [
    {
      operationType: "LOADING",
      startTime: ISODate("2025-12-15T09:00:00Z"),
      endTime: null,
      containersProcessed: 0,
      cranesUsed: ["CRANE-01", "CRANE-02"],
      staffAssigned: ["STAFF-101", "STAFF-102"],
      status: "STARTED",
      plannedOperationId: "674f9c8e-2025-PTLEI-000001-LOADING-0"
    }
  ],
  incidents: [],
  createdAt: ISODate("2025-12-15T08:15:00Z"),
  updatedAt: ISODate("2025-12-15T08:15:00Z")
}
```

### Data Flow
```
SPA → OEM API → VesselVisitExecutionController
  → VesselVisitExecutionService
    → OperationPlanRepository (fetch plan)
    → VesselVisitExecutionRepository (check duplicate)
    → VveIdGenerator (generate ID)
    → VesselVisitExecution (domain entity creation)
    → VesselVisitExecutionRepository (save VVE)
    → OperationPlanRepository (update plan status)
  ← VesselVisitExecutionDto
← JSON Response
```

### Integration Points
1. **Operation Plan**: Source of PlannedOperations for VVE initialization
2. **VVN Data**: Referenced but not duplicated (stored in Core Backend)
3. **MongoDB**: Persistent storage for VVE records
4. **SPA**: User interface for VVE creation and monitoring

---

## 4. Quality Attributes, SOLID Principles, and Evolution (ROBUSTNESS)

### Architectural Quality

**Single Responsibility Principle (SRP)**:
- **Controller**: HTTP handling
- **Service**: Use case orchestration (fetching plan, creating VVE, updating plan)
- **Entity**: Business rule enforcement (validations, state management)
- **Repository**: Persistence logic
- **Domain Service**: VVE ID generation

**Dependency Inversion Principle (DIP)**:
- Service depends on `IVesselVisitExecutionRepository` interface
- Service depends on `IOperationPlanRepository` interface
- Concrete implementations in infrastructure layer

**Open/Closed Principle (OCP)**:
- New VVE lifecycle events can be added without modifying existing code
- New validation rules can be added to entity

### Validation Strategy
**Multi-Layer Validation**:
1. **Presentation**: Input format validation (UUID, ISO 8601 date)
2. **Application**: Business logic validation (duplicate check, plan status)
3. **Domain**: Invariant enforcement (required fields, timestamp sequence)

### Sequential ID Generation
The sequential VVE ID pattern provides:
- **Human readability**: Easy to reference in communication
- **Predictability**: Operators can anticipate next ID
- **Auditability**: Clear chronological order of VVE creation
- **Simplicity**: No complex UUID generation

**Thread Safety**:
- MongoDB atomic operations ensure no ID collisions
- `getNextSequentialNumber()` uses count + 1 approach
- Alternative: MongoDB `findOneAndUpdate` with counter collection

### Derived Operations Pattern
Deriving ExecutedOperations from PlannedOperations:
- **Reduces manual data entry**: Operators don't re-enter operations
- **Ensures consistency**: Resources from plan are pre-assigned
- **Enables tracking**: Actual vs. planned comparison
- **Maintains traceability**: `plannedOperationId` links to original plan

### State Management
**VVE Lifecycle**:
1. **PLANNED** (not used in US 4.1.7, but defined in domain)
2. **IN_PROGRESS** (set when VVE is created)
3. **COMPLETED** (set in US 4.1.11 when departure is recorded)
4. **DISRUPTED** (optional, for incident-affected VVEs)

**Operation Plan Lifecycle**:
1. **GENERATED** (after US 4.1.2)
2. **APPROVED** (manually approved by operator)
3. **IN_EXECUTION** (set when first VVE is created - US 4.1.7)
4. **COMPLETED** (when all VVEs are completed)

### Error Handling
- **Domain errors**: Mapped to 422 Unprocessable Entity
- **Not found errors**: Mapped to 404 Not Found
- **Conflict errors**: Mapped to 409 Conflict
- **Validation errors**: Mapped to 400 Bad Request
- **All errors logged**: With context for debugging

### Testability
- **Unit tests**: Service can be tested with mocked repositories
- **Domain tests**: VVE entity and VveIdGenerator can be tested in isolation
- **Integration tests**: API endpoint can be tested end-to-end
- **Mock operation plans**: Test data can be seeded for testing

### Current Limitations and Recommendations

**Identified Gaps**:
1. **No VVE cancellation**: Once created, VVE cannot be cancelled (only completed)
2. **No rollback mechanism**: If plan update fails, VVE remains orphaned
3. **No notification system**: Operators aren't notified of VVE creation
4. **Limited audit trail**: Creation is logged, but not in persistent event log
5. **No validation of arrival time**: Arrival time could be in the future

**Recommended Improvements**:
1. Add VVE cancellation workflow (with reason and authorization)
2. Implement transactional consistency (atomic VVE creation + plan update)
3. Add event publishing for VVE creation (notify other modules)
4. Implement persistent event sourcing for complete audit trail
5. Add arrival time validation (must be <= current time, >= ETA - tolerance)
6. Support multiple VVEs for the same VVN (in case of multiple visits)
7. Add automatic status transitions based on time (e.g., auto-complete after X hours)

---

## Conclusion

User Story 4.1.7 successfully implements VVE creation as the transition point from planning to execution. The implementation fulfills all acceptance criteria:

✅ **REST API for VVE creation**: POST `/vessel-visit-executions/initialize`  
✅ **Links to existing VVN**: VVN ID is referenced, not duplicated  
✅ **Records required fields**: Vessel identifier (VVN), actual arrival time, creator user ID  
✅ **Automatic VVE identifier**: Sequential pattern (VVE-000001, VVE-000002, ...)  
✅ **Uses VVN information**: Derives ExecutedOperations from PlannedOperations  
✅ **Marks as IN_PROGRESS**: VVE status set correctly upon creation  

The implementation demonstrates:
- **Clean domain design** with proper aggregate root pattern
- **Robust integration** with operation plans
- **Auditability** through metadata recording
- **Idempotency** through duplicate detection
- **Sequential identifiers** for human readability
- **Derived operations** for reduced manual entry

This functionality serves as the foundation for all subsequent execution tracking (US 4.1.8 - 4.1.11), enabling real-time monitoring of vessel operations and comparison with planned activities.
