@startuml
title CD - US 4.1.11 Complete VVE (Domain + DIP)

skinparam classAttributeIconSize 0
skinparam shadowing false

enum VveStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
}

class VesselVisitExecution {
  +id: string
  +status: VveStatus

  +actualBerthTime: DateTime
  +actualUnberthTime: DateTime
  +actualPortDepartureTime: DateTime

  +completedAt: DateTime
  +completedBy: string

  +cargoOperations: List<CargoOperation>

  +recordUnberthing(unberthTime: DateTime)
  +markAsCompleted(departureTime: DateTime, userId: string)

  -ensureInProgress()
  -ensureTemporalConsistency()
  -ensureAllOperationsFinished()
}

class CargoOperation {
  +id: string
  +finishedAt: DateTime
  +isFinished(): boolean
}

interface IVesselVisitExecutionRepository {
  +findById(id: string): VesselVisitExecution
  +update(vve: VesselVisitExecution): VesselVisitExecution
}

class MongoVesselVisitExecutionRepository {
  +findById(id: string): VesselVisitExecution
  +update(vve: VesselVisitExecution): VesselVisitExecution
}

class VesselVisitExecutionService {
  -repo: IVesselVisitExecutionRepository
  +recordUnberth(id: string, unberthTime: DateTime, userId: string)
  +completeVve(id: string, departureTime: DateTime, userId: string)
}

VesselVisitExecution "1" o-- "*" CargoOperation
VesselVisitExecution ..> VveStatus

VesselVisitExecutionService --> IVesselVisitExecutionRepository : depends on abstraction (DIP)
IVesselVisitExecutionRepository <|.. MongoVesselVisitExecutionRepository : adapter

note right of VesselVisitExecution
Invariants:
- status must be IN_PROGRESS
- unberth must be recorded before completion
- departureTime > unberthTime
- all cargo operations finished
- after COMPLETED: read-only (except admin correction)
end note

@enduml
