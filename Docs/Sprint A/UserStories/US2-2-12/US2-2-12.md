# US 2.2.12 — Create, Update, Deactivate Physical Resources (ReadMe)

## Short summary
- **Purpose**: let Logistics Operators register and manage physical resources (cranes, trucks, gantries, other equipment) so planning/scheduling modules rely on accurate resource capabilities, availability and qualification requirements.
- **Scope**: CRUD (create, update) + activate/deactivate, search/filter. This story only records resources and their metadata — assignment/allocation to VVNs/dock slots/staff is handled by other stories.

## Acceptance checklist (quick)
- [ ] Resource Code is unique and immutable.
- [ ] Required at creation: Code, Description, Type, type-specific Capacity metric, SetupTimeSeconds. Default Availability = AVAILABLE.
- [ ] Optional: Installed/Assigned area (DockCode, StorageAreaId).
- [ ] RequiredQualifications list (qualification codes) maintained; qualification references validated.
- [ ] Deactivate/Reactivate preserves data/timestamps (no hard delete); operations idempotent.
- [ ] Searchable/filterable by code (partial), description (partial), type, availability and qualification.

## Business rules (high level)
- **Code**: canonical identifier, stored upper-case, cannot be changed after creation.
- **Capacity**: type-specific (STS crane -> AvgContainersPerHour, Truck -> ContainersPerTrip, YGC -> AvgContainersPerHour).
- **SetupTimeSeconds** must be >= 0.
- **RequiredQualifications** must reference existing StaffMemberQualification records.
- Assigned area must exist (Dock or StorageArea) when provided.
- Deactivate must set DeactivatedAt and DeactivationReason; record remains in DB for audit.

## API contract (recommended endpoints)
- **POST** `/api/resources/sts-cranes`
  - `CreateSTSCraneDto {
      Code, Description, SetupTimeSeconds, AvgContainersPerHour,
      InstalledAtDockCode?, RequiredQualificationIds?[], Availability?
    }`
  - Responses: 201 Created, 409 Conflict (code exists), 422 Validation error.
- **POST** `/api/resources/mobile-equipment`
  - `CreateMobileEquipmentDto {
      Code, Description, SetupTimeSeconds, Type (TRUCK|YARD_GANTRY_CRANE),
      ContainersPerTrip?, AvgContainersPerHour?, MaxLoadKg?, CurrentDockCode?,
      RequiredQualificationIds?[], Availability?
    }`
- **PUT** `/api/resources/sts-cranes/{code}`
  - `UpdateSTSCraneDto` (all mutable fields except Code)
- **PUT** `/api/resources/mobile-equipment/{code}`
  - `UpdateMobileEquipmentDto` (all mutable fields except Code)
- **PATCH** `/api/resources/{code}/deactivate`
  - `DeactivateResourceDto { Reason? }` — idempotent; sets DeactivatedAt and DeactivationReason
- **PATCH** `/api/resources/{code}/activate`
  - No body — idempotent
- **PATCH** `/api/resources/{code}/availability`
  - Body: `{ Availability: "AVAILABLE" | "MAINTENANCE" | "TEMP_OUT_OF_SERVICE" }`
- **GET** `/api/resources`
  - Query params: code, description, type, availability, qualification
  - Behavior: partial match for code/description; qualification filters resources requiring that qualification
- **GET** `/api/resources/{code}`

## Diagrams (render .puml files in this folder)
- SSDs
  - US2-2-12_SSD_ListResources.puml — listing/search flow
  - US2-2-12_SSD_CreateResource.puml — create flow
  - US2-2-12_SSD_UpdateResource.puml — update flow
  - US2-2-12_SSD_DeactivateResource.puml — deactivate/reactivate flow
- Sequence diagrams
  - US2-2-12_SD_Create.puml, US2-2-12_SD_Update.puml, US2-2-12_SD_Deactivate.puml
- Structural diagrams
  - US2-2-12_DM.puml — domain model
  - US2-2-12_CD.puml — class/controller/repository view
  - US2-2-12_C4_Container.puml — C4 container overview

## Domain summary (concise)
- **Aggregate**: PhysicalResource (ResourceId GUID + Code string)
- **Subtypes**: STSCrane, MobileEquipment (Truck, YardGantry)
- **Core attributes**:
  - Code (string, unique, immutable)
  - Description (string)
  - Type (enum)
  - Availability (enum)
  - SetupTimeSeconds (int)
  - Type-specific capacities (AvgContainersPerHour, ContainersPerTrip, MaxLoadKg)
  - RequiredQualifications: collection of StaffMemberQualification (references)
  - InstalledAtDockCode / AssignedStorageAreaId (optional)
  - CreatedAt, DeactivatedAt, DeactivationReason
- **Key behaviors**: Create (validate), Update (no Code change), Deactivate/Activate (idempotent), SetRequiredQualifications (validate existence)

## DTOs (summary)
- `CreateSTSCraneDto`
- `CreateMobileEquipmentDto`
- `UpdateSTSCraneDto`
- `UpdateMobileEquipmentDto`
- `DeactivateResourceDto { Reason? }`
- `PhysicalResourceResponseDto {
    ResourceId, Code, Description, Type, Availability, SetupTimeSeconds,
    RequiredQualifications[], Capacity fields, InstalledAtDockCode, CurrentDockCode,
    CreatedAt, DeactivatedAt, DeactivationReason
  }`

## Validation rules (server-side)
- **Code**: normalize to upper-case, trim; reject duplicates (409).
- **Capacity**: enforce type-specific required fields; return 422 on missing/invalid.
- **SetupTimeSeconds** >= 0; return 422 if negative.
- **Qualifications**: verify all referenced ids exist; return 422 with missing ids.
- **Assigned area**: verify dock/storage exists; return 422 if not found.

## Testing (suggested)
- `CreateResource_Valid_ReturnsCreated` (STS crane and MobileEquipment)
- `CreateResource_DuplicateCode_ReturnsConflict`
- `CreateResource_MissingTypeCapacity_Returns422`
- `UpdateResource_CannotChangeCode`
- `Deactivate_Reactivate_PreservesData_And_Idempotent`
- `Search_FilterByQualificationAndStatus`

## Implementation notes (practical)
- **Controller**: PhysicalResourcesController handles endpoints. Use DTO validation and map to domain entities.
- **Repository**: PhysicalResourceRepository should include RequiredQualifications when requested and provide search by qualification.
- **Domain**: Add factory/Update methods in STSCrane/MobileEquipment to validate capacities and invariants.
- **Persistence**: In PortDbContext ensure unique index on Code and proper FK/relationship mappings for qualifications and dock/storage links.
- **Audit**: keep CreatedAt/DeactivatedAt; consider DecisionLog/audit entity later if needed.
- **Dev seed**: add a few physical resources and qualifications to Program.cs for manual testing.

## Minimal examples
- **Create STS Crane**
  ```http
  POST /api/resources/sts-cranes
  {
    "Code":"STS001",
    "Description":"Ship-to-shore crane #1",
    "SetupTimeSeconds":600,
    "AvgContainersPerHour":30,
    "InstalledAtDockCode":"D1",
    "RequiredQualificationIds":["QUAL001"]
  }
  ```

- **Create Truck**
  ```http
  POST /api/resources/mobile-equipment
  {
    "Code":"TRUCK001",
    "Description":"Terminal truck",
    "SetupTimeSeconds":300,
    "Type":"TRUCK",
    "ContainersPerTrip":2,
    "RequiredQualificationIds":["QUAL002"]
  }
  ```

- **Deactivate**
  ```http
  PATCH /api/resources/STS001/deactivate
  Body: { "Reason":"Scheduled maintenance" }
  ```

## Notes / future work
- This story does not perform assignment/allocation. Later stories will use capacities, availability and required qualifications to match resources and staff and to schedule operations.
- Consider adding richer capacity models (weight, dimensions) and audit logs if required by regulation.

## References
- See US2-2-12_* .puml diagrams in this folder for sequence/system flows and the domain/class diagrams to guide implementation.
