# US 2.2.10 - View VVN Status

## 1. Requirements Engineering

### 1.1. User Story Description

*"As a Shipping Agent Representative, I want to view the status of all my submitted Vessel Visit Notifications (in progress, pending, approved with current dock assignment, or rejected with reason), so that I am always informed about the decisions of the Port Authority."*

### 1.2. Customer Specifications and Clarifications

**From the specifications document:**

> "The Shipping Agent Representative may also view the status of Vessel Visit Notifications submitted by other representatives working for the same shipping agent organization."

> "Vessel Visit Notifications must be searchable and filterable by vessel, status, representative and time."

**From the client clarifications:**

> **Question**:  
> "Can representatives see VVNs submitted by other representatives from the same organization?"
>
> **Answer**:  
> "Yes, all representatives from the same shipping agent organization should be able to view all VVNs submitted by anyone in their organization."

> **Question**:  
> "What information should be displayed for approved VVNs?"
>
> **Answer**:  
> "For approved VVNs, the system should show the current dock assignment including dock code, berth times, and assignment status."

> **Question**:  
> "What happens when a VVN is rejected?"
>
> **Answer**:  
> "When rejected, the VVN should display the rejection reason provided by the Port Authority. The shipping agent should be able to reopen the VVN, make corrections, and resubmit it."

### 1.3. Acceptance Criteria

* **AC1:** Shipping Agent Representatives can view the status of all VVNs submitted by themselves or other representatives from the same organization.
* **AC2:** VVNs must be searchable and filterable by vessel (IMO number).
* **AC3:** VVNs must be searchable and filterable by status (IN_PROGRESS, SUBMITTED, APPROVED, REJECTED).
* **AC4:** VVNs must be searchable and filterable by representative (submitter).
* **AC5:** VVNs must be searchable and filterable by time range.
* **AC6:** Approved VVNs must display dock assignment details (dock code, berth times, status).
* **AC7:** Rejected VVNs must display the rejection reason and rejection timestamp.
* **AC8:** Shipping Agent Representatives can reopen rejected VVNs to make corrections.

### 1.4. Found out Dependencies

* US 2.2.8 - Submit VVN (VVNs must be submitted before status can be viewed)
* US 2.2.9 - Approve/Reject VVN (Port Authority decisions create the statuses to view)
* Organization management (to scope VVNs by organization)
* Dock assignments (for approved VVNs)

### 1.5 Input and Output Data

**Input Data:**
* User authentication headers (X-User-Id, X-Org-Id, X-Role)
* Optional filter parameters:
    * Vessel IMO number
    * VVN status
    * Submitted by representative ID
    * Date range (from/to)

**Selected data:**
* Shipping Agent Organization

**Output Data:**
* List of VVN status records containing:
    * VVN ID and basic information (vessel, purpose, ETA/ETD)
    * Current status (IN_PROGRESS, SUBMITTED, APPROVED, REJECTED)
    * Timeline information (created, submitted, approved/rejected timestamps)
    * Crew and manifest counts
    * Dock assignment details (for approved VVNs)
    * Rejection reason (for rejected VVNs)
    * Submitter and decision-maker IDs

### 1.6. System Sequence Diagram (SSD)

**Main Flow - View All Organization VVNs:**
```
Shipping Agent Rep -> System: GET /vvns/my-organization
System -> System: Validate authentication
System -> System: Verify role (ShippingAgentRep)
System -> System: Filter VVNs by organization
System -> Shipping Agent Rep: Return VVN status list
```

**Alternative Flow - Filter by Status:**
```
Shipping Agent Rep -> System: GET /vvns/my-organization?status=REJECTED
System -> System: Validate authentication
System -> System: Apply status filter
System -> Shipping Agent Rep: Return filtered VVN status list
```

**Alternative Flow - Reopen Rejected VVN:**
```
Shipping Agent Rep -> System: POST /vvns/{id}:reopen
System -> System: Validate VVN is REJECTED
System -> System: Validate organization ownership
System -> System: Transition to IN_PROGRESS
System -> Shipping Agent Rep: Return updated status
```

### 1.7 Other Relevant Remarks

* All filters are optional and can be combined
* Results are ordered by creation date (most recent first)
* Organization scoping is automatic based on X-Org-Id header
* The reopen feature allows shipping agents to fix rejected VVNs

## 2. OO Analysis

### 2.1. Relevant Domain Model Excerpt

**Key Entities:**
* `VesselVisitNotification` - Aggregate root containing VVN data
* `Organization` - Shipping agent organization
* `DockAssignment` - Assigned dock for approved VVNs
* `DecisionLog` - Audit trail of Port Authority decisions

**Key Value Objects:**
* `VVNState` enum (IN_PROGRESS, SUBMITTED, APPROVED, REJECTED)
* `VisitPurpose` enum (LOAD, UNLOAD, BOTH, MAINTENANCE)
* `OrganizationId` - Value object for organization identification

### 2.2. Other Remarks

The domain model already includes the `ReopenToDraft()` method in the `VesselVisitNotification` entity, which was designed to handle the rejected VVN workflow. This implementation exposes that functionality through the API.

## 3. Design - User Story Realization

### 3.1. Rationale

**Design Decisions:**

1. **Organization-scoped filtering** - Automatically filter VVNs by the caller's organization to ensure data isolation
2. **Service layer method** - Created `GetVvnsForOrganizationAsync()` in `VesselVisitService` to encapsulate filtering logic
3. **Separate DTO** - Created `VvnStatusResponse` DTO to provide detailed status information including dock assignments
4. **Optional filters** - All query parameters are optional to support various use cases
5. **Eager loading** - Use EF Core `.Include()` for DockAssignment to avoid N+1 queries
6. **Explicit reopen endpoint** - Separate `POST /vvns/{id}:reopen` endpoint for clearer workflow

### Systematization

**API Endpoints:**

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/vvns/my-organization` | GET | View all VVNs for organization with filters |
| `/vvns/{id}:reopen` | POST | Reopen rejected VVN to IN_PROGRESS |

**Query Parameters for GET /vvns/my-organization:**
* `vesselImo` (string) - Filter by vessel IMO number
* `status` (string) - Filter by VVN state
* `submittedById` (Guid) - Filter by representative
* `fromDate` (DateTime) - Filter by creation date (start)
* `toDate` (DateTime) - Filter by creation date (end)

## 3.2. Sequence Diagram (SD)

**Sequence for GET /vvns/my-organization:**
```
ShippingAgentRep -> Controller: GET /vvns/my-organization?status=APPROVED
Controller -> CallerContextFactory: FromHeaders(headers)
CallerContextFactory -> Controller: CallerContext
Controller -> Controller: Validate role
Controller -> Service: GetVvnsForOrganizationAsync(orgId, filters)
Service -> DbContext: Query VesselVisitNotifications
DbContext -> Service: List<VesselVisitNotification>
Service -> Controller: List<VesselVisitNotification>
Controller -> Controller: Map to VvnStatusResponse
Controller -> ShippingAgentRep: 200 OK with VVN list
```

**Sequence for POST /vvns/{id}:reopen:**
```
ShippingAgentRep -> Controller: POST /vvns/{id}:reopen
Controller -> CallerContextFactory: FromHeaders(headers)
Controller -> Controller: Validate role & organization
Controller -> DbContext: Find VVN by ID
DbContext -> Controller: VesselVisitNotification
Controller -> VVN: ReopenToDraft()
VVN -> VVN: Validate state is REJECTED
VVN -> VVN: Clear rejection data, set IN_PROGRESS
Controller -> DbContext: SaveChanges()
Controller -> ShippingAgentRep: 200 OK with updated status
```

**Design Patterns used:**

* Layered Architecture (Presentation / Application / Domain / Infrastructure)
* RESTful API design with resource-oriented URLs
* Repository Pattern (via EF Core DbContext)
* Service Layer Pattern (VesselVisitService)
* DTO Pattern (VvnStatusResponse, DockAssignmentInfo)
* Query Object Pattern (filter parameters)
* Factory Pattern (CallerContextFactory)
* Value Object Pattern (OrganizationId, UserId)
* Domain Model Pattern (VVN state transitions)
* Dependency Injection (DbContext, Service)

## 3.3. Class Diagram (CD)

**Key Classes:**

```
VesselVisitNotificationsController
  + GetMyOrganizationVvns(filters): ActionResult<IEnumerable<VvnStatusResponse>>
  + ReopenToDraft(id): ActionResult
  - EnsureSameOrgAsync(vvnId, orgId): Task<bool>

VesselVisitService
  + GetVvnsForOrganizationAsync(orgId, vesselImo, status, submittedById, fromDate, toDate): Task<List<VesselVisitNotification>>

VvnStatusResponse (DTO)
  + Id: Guid
  + Status: string
  + VesselImo: string
  + Purpose: string
  + Eta, Etd: DateTime
  + CreatedAt, SubmittedAt, ApprovedAt, RejectedAt: DateTime?
  + DockAssignment: DockAssignmentInfo?
  + RejectionReason: string?
  + CaptainName: string
  + CrewCount: int
  + LoadingCount, UnloadingCount: int

DockAssignmentInfo (DTO)
  + DockAssignmentId: Guid
  + DockCode: string
  + BerthFrom, BerthTo: DateTime
  + Status: string

VesselVisitNotification (Domain Entity)
  + VvnGuid: Guid
  + State: VVNState
  + OrganizationId: OrganizationId
  + DockAssignment: DockAssignment?
  + RejectionReason: string?
  + ReopenToDraft(): void
```

# 4. Tests

**Test 1 - Get all VVNs for organization**

```csharp
[Fact]
public async Task GetMyOrganizationVvns_ValidRequest_ReturnsAllOrgVvns()
{
    // Arrange
    var orgId = Guid.NewGuid();
    var rep1Id = Guid.NewGuid();
    var rep2Id = Guid.NewGuid();
    
    // Create VVNs for the organization
    var vvn1 = new VesselVisitNotification("IMO9123456", VisitPurpose.LOAD, 
        DateTime.UtcNow.AddDays(1), DateTime.UtcNow.AddDays(2), 
        "Captain A", 25, new OrganizationId(orgId));
    
    var vvn2 = new VesselVisitNotification("IMO9234567", VisitPurpose.UNLOAD, 
        DateTime.UtcNow.AddDays(3), DateTime.UtcNow.AddDays(4), 
        "Captain B", 30, new OrganizationId(orgId));
    
    _context.VesselVisitNotifications.AddRange(vvn1, vvn2);
    await _context.SaveChangesAsync();
    
    // Act
    var result = await _controller.GetMyOrganizationVvns();
    
    // Assert
    var okResult = Assert.IsType<OkObjectResult>(result.Result);
    var vvns = Assert.IsAssignableFrom<IEnumerable<VvnStatusResponse>>(okResult.Value);
    Assert.Equal(2, vvns.Count());
}
```

**Test 2 - Filter VVNs by status**

```csharp
[Fact]
public async Task GetMyOrganizationVvns_FilterByStatus_ReturnsOnlyMatchingVvns()
{
    // Arrange
    var orgId = Guid.NewGuid();
    var vvn1 = CreateVvn(orgId, VVNState.APPROVED);
    var vvn2 = CreateVvn(orgId, VVNState.REJECTED);
    var vvn3 = CreateVvn(orgId, VVNState.APPROVED);
    
    _context.VesselVisitNotifications.AddRange(vvn1, vvn2, vvn3);
    await _context.SaveChangesAsync();
    
    // Act
    var result = await _controller.GetMyOrganizationVvns(status: "APPROVED");
    
    // Assert
    var okResult = Assert.IsType<OkObjectResult>(result.Result);
    var vvns = Assert.IsAssignableFrom<IEnumerable<VvnStatusResponse>>(okResult.Value);
    Assert.Equal(2, vvns.Count());
    Assert.All(vvns, v => Assert.Equal("APPROVED", v.Status));
}
```

**Test 3 - Organization isolation**

```csharp
[Fact]
public async Task GetMyOrganizationVvns_DifferentOrg_ReturnsEmpty()
{
    // Arrange
    var org1 = Guid.NewGuid();
    var org2 = Guid.NewGuid();
    var vvn1 = CreateVvn(org1);
    var vvn2 = CreateVvn(org2);
    
    _context.VesselVisitNotifications.AddRange(vvn1, vvn2);
    await _context.SaveChangesAsync();
    
    // Set caller to org1
    SetCallerContext(org1);
    
    // Act
    var result = await _controller.GetMyOrganizationVvns();
    
    // Assert
    var okResult = Assert.IsType<OkObjectResult>(result.Result);
    var vvns = Assert.IsAssignableFrom<IEnumerable<VvnStatusResponse>>(okResult.Value);
    Assert.Single(vvns); // Only org1's VVN
}
```

**Test 4 - Reopen rejected VVN**

```csharp
[Fact]
public async Task ReopenToDraft_RejectedVvn_ReturnsInProgress()
{
    // Arrange
    var orgId = Guid.NewGuid();
    var vvn = CreateVvn(orgId);
    vvn.Submit(new UserId(Guid.NewGuid()));
    vvn.Reject(new UserId(Guid.NewGuid()), "Invalid vessel");
    
    _context.VesselVisitNotifications.Add(vvn);
    await _context.SaveChangesAsync();
    
    SetCallerContext(orgId);
    
    // Act
    var result = await _controller.ReopenToDraft(vvn.VvnGuid);
    
    // Assert
    var okResult = Assert.IsType<OkObjectResult>(result);
    var response = okResult.Value;
    Assert.Equal("IN_PROGRESS", response.GetType().GetProperty("status").GetValue(response));
}
```

**Test 5 - Cannot reopen non-rejected VVN**

```csharp
[Fact]
public async Task ReopenToDraft_SubmittedVvn_ReturnsConflict()
{
    // Arrange
    var orgId = Guid.NewGuid();
    var vvn = CreateVvn(orgId);
    vvn.Submit(new UserId(Guid.NewGuid())); // SUBMITTED state
    
    _context.VesselVisitNotifications.Add(vvn);
    await _context.SaveChangesAsync();
    
    SetCallerContext(orgId);
    
    // Act
    var result = await _controller.ReopenToDraft(vvn.VvnGuid);
    
    // Assert
    Assert.IsType<ConflictObjectResult>(result);
}
```

**Test 6 - Approved VVN includes dock assignment**

```csharp
[Fact]
public async Task GetMyOrganizationVvns_ApprovedVvn_IncludesDockAssignment()
{
    // Arrange
    var orgId = Guid.NewGuid();
    var vvn = CreateVvn(orgId);
    vvn.Submit(new UserId(Guid.NewGuid()));
    
    var dockAssignment = DockAssignment.Create(
        vvn.VvnGuid, "DOCK-A1", 
        DateTime.UtcNow, DateTime.UtcNow.AddDays(1),
        Guid.NewGuid().ToString(), DateTime.UtcNow);
    
    vvn.Approve(new UserId(Guid.NewGuid()), dockAssignment.DockAssignmentId);
    
    _context.VesselVisitNotifications.Add(vvn);
    _context.DockAssignments.Add(dockAssignment);
    await _context.SaveChangesAsync();
    
    SetCallerContext(orgId);
    
    // Act
    var result = await _controller.GetMyOrganizationVvns(status: "APPROVED");
    
    // Assert
    var okResult = Assert.IsType<OkObjectResult>(result.Result);
    var vvns = Assert.IsAssignableFrom<IEnumerable<VvnStatusResponse>>(okResult.Value);
    var vvnResponse = vvns.First();
    Assert.NotNull(vvnResponse.DockAssignment);
    Assert.Equal("DOCK-A1", vvnResponse.DockAssignment.DockCode);
}
```

# 5. Construction (Implementation)

## 5.1. Created Files

**DTOs/Vvns/VvnStatusResponse.cs**
```csharp
public class VvnStatusResponse
{
    public Guid Id { get; set; }
    public string Status { get; set; } = null!;
    public string VesselImo { get; set; } = null!;
    public string Purpose { get; set; } = null!;
    public DateTime Eta { get; set; }
    public DateTime Etd { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime? SubmittedAt { get; set; }
    public DateTime? ApprovedAt { get; set; }
    public DateTime? RejectedAt { get; set; }
    public Guid? SubmittedById { get; set; }
    public string CaptainName { get; set; } = null!;
    public int CrewCount { get; set; }
    public int LoadingCount { get; set; }
    public int UnloadingCount { get; set; }
    public DockAssignmentInfo? DockAssignment { get; set; }
    public Guid? ApprovedById { get; set; }
    public string? RejectionReason { get; set; }
    public Guid? RejectedById { get; set; }
}

public class DockAssignmentInfo
{
    public Guid DockAssignmentId { get; set; }
    public string DockCode { get; set; } = null!;
    public DateTime BerthFrom { get; set; }
    public DateTime BerthTo { get; set; }
    public string Status { get; set; } = null!;
}
```

## 5.2. Modified Files

**Application/Services/VesselVisitService.cs**
- Added `GetVvnsForOrganizationAsync()` method with filtering logic

**Controllers/VesselVisitNotificationsController.cs**
- Added `GET /vvns/my-organization` endpoint
- Added `POST /vvns/{id}:reopen` endpoint

# 6. Integration and Demo

## 6.1. API Usage Examples

**Example 1: Get all VVNs for organization**
```bash
curl -X GET "http://localhost:5000/vvns/my-organization" \
  -H "X-User-Id: 550e8400-e29b-41d4-a716-446655440000" \
  -H "X-Org-Id: 123e4567-e89b-12d3-a456-426614174000" \
  -H "X-Role: shippingagentrep"
```

**Example 2: Filter by status**
```bash
curl -X GET "http://localhost:5000/vvns/my-organization?status=APPROVED" \
  -H "X-User-Id: 550e8400-e29b-41d4-a716-446655440000" \
  -H "X-Org-Id: 123e4567-e89b-12d3-a456-426614174000" \
  -H "X-Role: shippingagentrep"
```

**Example 3: Reopen rejected VVN**
```bash
curl -X POST "http://localhost:5000/vvns/{vvn-id}:reopen" \
  -H "X-User-Id: 550e8400-e29b-41d4-a716-446655440000" \
  -H "X-Org-Id: 123e4567-e89b-12d3-a456-426614174000" \
  -H "X-Role: shippingagentrep"
```

## 6.2. Demo Scenarios

**Scenario 1: View all organization VVNs**
1. Shipping agent representative logs in
2. Navigate to "My VVNs" page
3. System displays all VVNs from the organization
4. VVNs show current status with color indicators

**Scenario 2: Filter rejected VVNs and fix issues**
1. Representative filters by status "REJECTED"
2. System shows all rejected VVNs with rejection reasons
3. Representative clicks "Reopen" on a rejected VVN
4. System moves VVN to IN_PROGRESS state
5. Representative edits VVN to fix issues
6. Representative resubmits VVN

# 7. Observations

## 7.1. Key Features Implemented

* ✅ Organization-scoped VVN viewing
* ✅ Cross-representative access within same organization
* ✅ Comprehensive filtering (vessel, status, representative, time)
* ✅ Detailed status information
* ✅ Dock assignment details for approved VVNs
* ✅ Rejection reason display for rejected VVNs
* ✅ Reopen workflow for rejected VVNs

## 7.2. Security Considerations

* Role-based access control (ShippingAgentRep only)
* Organization isolation (automatic filtering by org)
* Authorization checks on reopen endpoint
* No cross-organization data leakage

## 7.3. Performance Notes

* EF Core eager loading for dock assignments (no N+1 queries)
* Indexed queries on OrganizationId, VesselImo, State, CreatedAt
* Results ordered by most recent first

## 7.4. Future Enhancements

* Pagination for large result sets
* Custom sorting options
* Export to CSV/Excel
* Real-time updates via SignalR
* Decision log/audit trail viewing
