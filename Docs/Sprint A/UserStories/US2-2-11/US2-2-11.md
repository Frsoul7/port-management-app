# US 2.2.11 - Register and Manage Operating Staff Members

## 1. Description (short)
As a Logistics Operator, I want to register and manage operating staff members (create, update, deactivate/activate), so that staff availability and qualifications are accurately recorded and can be used later when pairing staff with physical resources.

## 2. Requirements Engineering

### 2.1 User story
"As a Logistics Operator, I need to create, update and deactivate staff member records including their operational windows and qualifications so that resource allocation modules can rely on accurate availability and competence data."

### 2.2 Business constraints
- The mecanographic number (internal staff identifier) is globally unique and immutable.
- Mandatory fields at creation: mecanographic number, short name, contact details (email and phone), and status. A newly created staff member must default to "AVAILABLE".
- Other fields (qualifications, operational window) may be added at creation or later via update.
- Deactivation must preserve all historical data (no hard delete).
- The system must support searching/filtering staff by ID, name, status and qualifications.

### 2.3 Acceptance Criteria (derived)
AC1: Create staff member with unique mecanographic number, short name, email, phone, and status; default status = AVAILABLE.  
AC2: Mecanographic number cannot be changed after creation.  
AC3: Optional fields (qualifications, operational window) may be set at creation or later via update.  
AC4: Update operation can modify all fields except mecanographic number. Partial records are allowed (fields can be added/filled later) but mandatory fields must exist at creation.  
AC5: Deactivate/reactivate preserves audit information (timestamps, previous status). Deactivation must be idempotent.  
AC6: Staff search supports filters: mecanographic number, short name (partial match), status (AVAILABLE/UNAVAILABLE/TEMPORARILY_REASSIGNED), and qualification (search by qualification id or name).  
AC7: When assigning staff to resources (future stories) the system will consider qualifications and overlapping operational windows; this story does not perform any staff-to-resource assignment.

## 3. Clarifications / Client Q&A (selected)
Q: Can a staff member operate more than one resource during their window if they have required qualifications?  
A: Yes — a staff member can operate multiple resources provided qualifications and time windows allow. US 2.2.11 only records the staff availability and qualifications; actual assignment logic is covered by other user stories.

Q: Can a staff record be incomplete and later completed via update?  
A: Yes. Creation requires mandatory fields. Other fields are optional at creation and may be updated later. Updates cannot change the mecanographic number.

Q: Are staff marked AVAILABLE by default upon registration?  
A: Yes. Newly registered staff become AVAILABLE unless an explicit status is provided.

## 4. OO Analysis (concise)
Relevant domain entity: StaffMember
- Identity: MecanographicNumber (long) — unique, immutable
- Attributes:
  - ShortName (string, required)
  - Email (string, required)
  - Phone (string, required)
  - Status (HumanResourceStatus enum) — AVAILABLE | UNAVAILABLE | TEMPORARILY_REASSIGNED
  - StartHour / EndHour (TimeSpan) — operational window
  - Qualifications: collection of StaffMemberQualification references
  - CreatedAt, DeactivatedAt, IsActive / ActiveStatus
- Behavior:
  - Create(...) — enforce mandatory fields and uniqueness.
  - Update(...) — cannot change MecanographicNumber; validate fields.
  - Deactivate() / Activate() — set flags and timestamps; preserve history.
  - AddQualification / RemoveQualification

Related value objects / aggregates:
- StaffMemberQualification (existing entity)
- (UI/API) DTOs to create/update/search staff

Notes:
- This story avoids resource allocation logic; it provides accurate data to be consumed later.

## 5. Design — API Endpoints (suggested)
- POST /api/staff
  - Body: CreateStaffMemberDto { MecanographicNumber, ShortName, Email, Phone, Status? (optional), StartHour?, EndHour?, QualificationIds? }
  - Behaviour: create, return 201 + created entity.
- PUT /api/staff/{mecanographicNumber}
  - Body: UpdateStaffMemberDto { ShortName?, Email?, Phone?, Status?, StartHour?, EndHour?, QualificationIds? }
  - Behaviour: update allowed fields; 404 if not found; 409 on business conflicts.
- PATCH /api/staff/{mecanographicNumber}/deactivate
  - Body: optional reason
  - Behaviour: set status/inactive, record DeactivatedAt.
- PATCH /api/staff/{mecanographicNumber}/activate
  - Behaviour: mark active, clear deactivation timestamp.
- GET /api/staff
  - Query filters: id, name, status, qualification
  - Behaviour: supports partial name matches and qualification filtering.
- POST /api/staff/{mecanographicNumber}/qualifications/{qualificationId}
  - Behaviour: add qualification to staff
- DELETE /api/staff/{mecanographicNumber}/qualifications/{qualificationId}
  - Behaviour: remove qualification

Design decisions:
- Creation must validate uniqueness of mecanographic number and required contact fields.
- Use TimeSpan for StartHour/EndHour in API (or ISO time strings) and store as required in EF mapping.
- Deactivation preserves entity data (no deletes), and should be idempotent.

## 6. DTOs (examples)
- CreateStaffMemberDto (MecanographicNumber, ShortName, Email, Phone, Status? default AVAILABLE, StartHour? string "HH:mm", EndHour? string, QualificationIds? List<string>)
- UpdateStaffMemberDto (ShortName?, Email?, Phone?, Status?, StartHour? TimeSpan?, EndHour? TimeSpan?, QualificationIds?)
- StaffMemberResponseDto (MecanographicNumber, ShortName, Email, Phone, Status, StartHour, EndHour, Qualifications[], CreatedAt, DeactivatedAt)

## 7. Tests (suggested)
Test 1 — CreateStaff_Valid_ReturnsCreated
- Create staff with mandatory fields; expect 201, status AVAILABLE and stored.

Test 2 — CreateStaff_DuplicateMecanographicNumber_ReturnsConflict
- Create twice same mecanographic number → 409 Conflict.

Test 3 — UpdateStaff_CanModifyFieldsExceptMecanographicNumber
- Update name, email, operational window, qualifications. Ensure mecanographic number unchanged.

Test 4 — Deactivate_Reactivation_PreservesAudit
- Deactivate staff -> IsActive false, DeactivatedAt set. Reactivate -> IsActive true, DeactivatedAt cleared (or preserved in audit log elsewhere) and operation idempotent.

Test 5 — Search_FilterByQualificationAndStatus
- Create staff with qualifications and different statuses; query filters return expected results.

## 8. Implementation notes (which files to change)
- Controllers/HumanResourcesController.cs already contains most endpoints and can be extended/used (verify it matches AC). Ensure:
  - POST validates mandatory fields and sets default status AVAILABLE.
  - PUT disallows change of mecanographic number.
  - Deactivate/Activate endpoints preserve data and are idempotent.
  - Search supports qualification filter and partial name matches.
- Domain/HumanResources/StaffMember.cs should expose methods: AddQualification, RemoveQualification, UpdateContactInfo, UpdateOperationalStatus, UpdateWorkingHours, Activate/Deactivate (the codebase already has many of these; verify behavioural invariants).
- Repositories/StaffMemberRepository.cs and QualificationRepository.cs already exist; reuse them.
- DTOs under DTOs/HumanResources should match the suggested shapes; create or adapt if missing.
- Add/extend tests under the test project to cover acceptance criteria.

## 9. Observations and future work
- This story intentionally avoids staff-to-resource pairing. When implementing allocation (future US), the system should:
  - Use staff operational windows and qualifications to verify coverage and to compute handover times.
  - Consider partial overlaps and allow multiple allocations within a single staff window when feasible.
- Keep audit trails (who deactivated/activated and when) if regulatory/audit requirements arise. For now, preserve timestamps and do not hard-delete records.

## 10. Minimal example payloads

Create staff:
```json
POST /api/staff
{
  "MecanographicNumber": 1003,
  "ShortName": "Maria Lopes",
  "Email": "maria.lopes@example.com",
  "Phone": "+351912345678",
  "StartHour": "08:00",
  "EndHour": "18:00",
  "QualificationIds": [ "QUAL001" ]
}
```

Update staff:
```json
PUT /api/staff/1003
{
  "ShortName": "Maria L.",
  "Email": "maria.l@example.com",
  "QualificationIds": [ "QUAL001", "QUAL002" ],
  "Status": "AVAILABLE"
}
```

Deactivate:
POST /api/staff/1003/deactivate
Body optional: { "reason": "On leave" }

Search:
GET /api/staff?name=maria&status=AVAILABLE&qualification=QUAL001

--- End of US 2.2.11 documentation ---
