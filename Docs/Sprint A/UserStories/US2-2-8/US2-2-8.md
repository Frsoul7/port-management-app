# US 2.2.8 – Create & Submit Vessel Visit Notification (VVN)

## 1. Requirements Engineering

### 1.1. User Story Description

*“As a Shipping Agent Representative, I want to create/submit a Vessel Visit Notification, so that the vessel berthing and subsequent (un)loading operations at the port are scheduled and planned in space and timely manner.”*

### 1.2. Customer Specifications and Clarifications

**From the specifications document:**
- The Cargo Manifest data for unloading and/or loading is included.
- The system must validate that referred containers identifiers comply with the ISO 6346:2022 standard.
- Information about the crew (name, citizen id, nationality) might be requested, when necessary, for compliance with security protocols.
- Vessel Visit Notifications might become at an **“in progress”** status (e.g., cargo information is incomplete) to be further updated/completed.
- When completed / ready for asking approval, the agent is required to change its state to **“submitted.”**

**Observed in current codebase (alignment):**
- `VesselVisitNotification` aggregate with states `IN_PROGRESS`, `SUBMITTED`, `APPROVED`, `REJECTED`.
- `CargoManifest` (load/unload) with `ManifestEntry` (validated via `Iso6346.IsValid(...)`).
- Crew handling via `CrewMember` and policy `HazardousRequiresCrewPolicy` that enforces extra crew data when hazardous cargo exists.
- Application service `VesselVisitService` exposes `CreateVvnAsync(...)`, `AddManifestEntryAsync(...)`, `SubmitAsync(...)` used by `VesselVisitNotificationsController`.

### 1.3. Acceptance Criteria

- **AC1 – Include Manifests:** A VVN may include **Loading** and/or **Unloading** cargo manifests.
- **AC2 – ISO 6346 Validation:** Every container code in a manifest MUST pass ISO 6346:2022 format & check digit validation.
- **AC3 – Crew Info on Demand:** System may require detailed crew list (name, citizen id, nationality) when policies apply (e.g., hazardous cargo).
- **AC4 – In-Progress State:** The VVN can be saved in **IN_PROGRESS** while details (e.g., cargo, crew) are incomplete.
- **AC5 – Submit:** When ready, the agent **submits** the VVN → state **SUBMITTED**; submission is blocked if mandatory info/policies aren’t satisfied.

### 1.4. Dependencies / Preconditions

- Vessel and Organization (agent) must exist and be valid.
- If hazardous cargo is present, at least one specialized **CrewMember** is required by policy.
- Time window (ETA/ETD) must be defined to allow scheduling downstream.

## 2. System Analysis (C4+ & SSD)

- **Primary Actor:** Shipping Agent Representative.
- **System:** Port Management Backend (Web API + Application + Persistence).
- **Happy Path:** Create draft VVN → add cargo entries (optional load/unload) → add crew (if needed) → submit.
- **Alternative Paths:** Keep draft **IN_PROGRESS**; correct ISO 6346 errors; fulfill crew policy, then resubmit.

**Diagrams:**
- System Sequence Diagrams (SSD) for Create/Edit and Submit flows: see
  - `US2-2-8_SSD_CreateVVN.puml`
  - `US2-2-8_SSD_SubmitVVN.puml`
- Sequence Diagram (detailed): `US2-2-8_SD.puml`
- Class Diagram excerpt (aggregate + related): `US2-2-8_CD.puml`
- C4 Container View (extra for C4+): `US2-2-8_C4_Container.puml`

## 3. Design Notes (DDD)

- **Aggregate Root:** `VesselVisitNotification` (VVN) — owns state, references manifests & crew, enforces editability in `IN_PROGRESS`/`REJECTED` only.
- **Entities/Value Objects:**
  - `CargoManifest` → `LoadingCargoManifest` / `UnloadingCargoManifest`
  - `ManifestEntry` with ISO 6346 validation
  - `CrewMember`
  - `OrganizationId`, `UserId` value objects (referenced)
- **Domain Policy:** `HazardousRequiresCrewPolicy` checked at **Submit**.
- **Application Service:** `VesselVisitService` orchestrates create, add entries, and submit; defers rules to domain.
- **Persistence:** EF Core mappings via `PortDbContext` and configurations.

## 4. Links to Diagrams

- Class Diagram excerpt → `US2-2-8_CD.puml`
- SSD – Create/Update VVN → `US2-2-8_SSD_CreateVVN.puml`
- SSD – Submit VVN → `US2-2-8_SSD_SubmitVVN.puml`
- Sequence Diagram → `US2-2-8_SD.puml`
- C4 Container (extra) → `US2-2-8_C4_Container.puml`

> **Style:** This file follows the structure used in `Docs/Sprint A/UserStories/US2-2-1.md` and `US2-2-2.md`, focusing on succinct RE + diagrams.
