<div class="edit-operation-plan-container">
  <!-- Header -->
  <div class="page-header">
    <button class="btn-back" (click)="goBack()">← Back to Plans</button>
    <h1>Edit Operation Plan</h1>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading()" class="loading-container">
    <div class="spinner"></div>
    <p>Loading operation plan...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error() && !operationPlan()" class="error-container">
    <p class="error-message">{{ error() }}</p>
    <button class="btn-secondary" (click)="goBack()">Go Back</button>
  </div>

  <!-- Main Content -->
  <div *ngIf="!loading() && operationPlan()" class="content">
    <!-- Plan Info Card -->
    <div class="plan-info-card">
      <div class="info-row">
        <div class="info-item">
          <label>Target Date:</label>
          <span>{{ formatDate(operationPlan()!.targetDate) }}</span>
        </div>
        <div class="info-item">
          <label>Status:</label>
          <span class="status-badge" [class]="'status-' + operationPlan()!.status.toLowerCase()">
            {{ operationPlan()!.status }}
          </span>
        </div>
        <div class="info-item">
          <label>Algorithm:</label>
          <span>{{ operationPlan()!.algorithm }}</span>
        </div>
        <div class="info-item">
          <label>Total Operations:</label>
          <span>{{ operationPlan()!.operations.length }}</span>
        </div>
      </div>

      <div *ngIf="!isEditable()" class="warning-message">
        ⚠️ This plan cannot be edited because its status is {{ operationPlan()!.status }}.
        Only GENERATED or APPROVED plans can be edited.
      </div>
    </div>

    <!-- Success Message -->
    <div *ngIf="successMessage()" class="success-message">
      ✓ {{ successMessage() }}
    </div>

    <!-- Error Message -->
    <div *ngIf="error()" class="error-message">
      ✗ {{ error() }}
    </div>

    <!-- Audit Log Button -->
    <div class="audit-log-toggle" *ngIf="operationPlan()!.auditLog && operationPlan()!.auditLog!.length > 0">
      <button class="btn-secondary" (click)="toggleAuditLog()">
        {{ showAuditLog() ? 'Hide' : 'Show' }} Audit Log
      </button>
    </div>

    <!-- Audit Log -->
    <div *ngIf="showAuditLog() && operationPlan()!.auditLog" class="audit-log-card">
      <h3>Audit Log</h3>
      <div class="audit-entries">
        <div *ngFor="let entry of operationPlan()!.auditLog" class="audit-entry">
          <div class="audit-header">
            <span class="audit-action" [ngClass]="getAuditActionClass(entry.action)">
              {{ entry.action }}
            </span>
            <span class="audit-timestamp">{{ formatDate(entry.timestamp) }}</span>
          </div>
          <div class="audit-body">
            <p><strong>User:</strong> {{ entry.userName }} ({{ entry.userId }})</p>
            <p *ngIf="entry.vvnId"><strong>VVN:</strong> {{ entry.vvnId }}</p>
            <p *ngIf="entry.reason"><strong>Reason:</strong> {{ entry.reason }}</p>
            <div *ngIf="entry.changes && entry.changes.length > 0" class="audit-changes">
              <strong>Changes:</strong>
              <ul>
                <li *ngFor="let change of entry.changes">
                  <strong>{{ change.field }}:</strong>
                  <span class="old-value">{{ change.oldValue }}</span> →
                  <span class="new-value">{{ change.newValue }}</span>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Operations Table -->
    <div class="operations-card">
      <h2>Operations</h2>
      <table class="operations-table">
        <thead>
          <tr>
            <th>VVN ID</th>
            <th>Vessel IMO</th>
            <th>Type</th>
            <th>Planned Start</th>
            <th>Planned End</th>
            <th>Cranes</th>
            <th>Dock</th>
            <th>Staff</th>
            <th *ngIf="isEditable()">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let operation of operationPlan()!.operations">
            <td>{{ operation.vvnId }}</td>
            <td>{{ operation.vesselImo }}</td>
            <td>{{ operation.operationType }}</td>
            <td>{{ formatDate(operation.plannedStart) }}</td>
            <td>{{ formatDate(operation.plannedEnd) }}</td>
            <td>{{ operation.assignedCranes }}</td>
            <td>{{ operation.assignedDock || 'N/A' }}</td>
            <td>{{ operation.assignedStaff?.length || 0 }} staff</td>
            <td *ngIf="isEditable()">
              <button
                class="btn-edit"
                (click)="selectOperation(operation)"
                [disabled]="selectedOperation() !== null"
              >
                ✏️ Edit
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Edit Operation Panel -->
    <div *ngIf="selectedOperation() && editedOperation" class="edit-panel">
      <div class="edit-panel-header">
        <h3>Edit Operation: {{ selectedOperation()!.vvnId }}</h3>
        <button class="btn-close" (click)="cancelEdit()">✕</button>
      </div>

      <div class="edit-form">
        <div class="form-row">
          <div class="form-group">
            <label for="plannedStart">Planned Start</label>
            <input
              type="datetime-local"
              id="plannedStart"
              [(ngModel)]="editedOperation.plannedStart"
              class="input-field"
            />
          </div>

          <div class="form-group">
            <label for="plannedEnd">Planned End</label>
            <input
              type="datetime-local"
              id="plannedEnd"
              [(ngModel)]="editedOperation.plannedEnd"
              class="input-field"
            />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="assignedCranes">Assigned Cranes</label>
            <input
              type="number"
              id="assignedCranes"
              [(ngModel)]="editedOperation.assignedCranes"
              min="1"
              class="input-field"
            />
          </div>

          <div class="form-group">
            <label for="assignedDock">Assigned Dock</label>
            <input
              type="text"
              id="assignedDock"
              [(ngModel)]="editedOperation.assignedDock"
              placeholder="e.g., D1, D2"
              class="input-field"
            />
          </div>
        </div>

        <div class="form-group full-width">
          <label for="updateReason">Reason for Update *</label>
          <textarea
            id="updateReason"
            [(ngModel)]="updateReason"
            placeholder="Please explain why this operation is being updated..."
            rows="3"
            class="input-field"
            required
          ></textarea>
        </div>

        <div class="form-actions">
          <button class="btn-secondary" (click)="cancelEdit()" [disabled]="saving()">
            Cancel
          </button>
          <button
            class="btn-check"
            (click)="checkConflicts()"
            [disabled]="checkingConflicts() || saving()"
          >
            {{ checkingConflicts() ? 'Checking...' : 'Check Conflicts' }}
          </button>
          <button
            class="btn-primary"
            (click)="saveOperation()"
            [disabled]="!updateReason.trim() || saving()"
          >
            {{ saving() ? 'Saving...' : 'Save Changes' }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Conflict Warning Modal -->
  <div *ngIf="showConflictModal()" class="modal-overlay" (click)="closeConflictModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>⚠️ Conflicts Detected</h3>
        <button class="btn-close" (click)="closeConflictModal()">✕</button>
      </div>

      <div class="modal-body">
        <p *ngIf="hasErrors()" class="conflict-error-msg">
          <strong>Critical conflicts detected.</strong> These must be resolved before saving.
        </p>
        <p *ngIf="hasOnlyWarnings()" class="conflict-warning-msg">
          <strong>Warnings detected.</strong> You can proceed with caution.
        </p>

        <div class="conflicts-list">
          <div
            *ngFor="let conflict of conflicts()"
            class="conflict-item"
            [ngClass]="getConflictSeverityClass(conflict.severity)"
          >
            <div class="conflict-header">
              <span class="conflict-type">{{ conflict.type }}</span>
              <span class="conflict-severity">{{ conflict.severity }}</span>
            </div>
            <p class="conflict-message">{{ conflict.message }}</p>
            <div class="conflict-details">
              <p><strong>Conflicting VVN:</strong> {{ conflict.conflictingVvnId }}</p>
              <p><strong>Vessel:</strong> {{ conflict.conflictingVesselImo }}</p>
              <p><strong>Overlap:</strong> {{ formatDate(conflict.overlap.start) }} -
                {{ formatDate(conflict.overlap.end) }}
                ({{ conflict.overlap.durationMinutes }} minutes)</p>
              <p *ngIf="conflict.affectedResource">
                <strong>Resource:</strong> {{ conflict.affectedResource }}
              </p>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeConflictModal()">
          Cancel
        </button>
        <button
          *ngIf="hasOnlyWarnings()"
          class="btn-warning"
          (click)="proceedDespiteWarnings()"
          [disabled]="saving()"
        >
          {{ saving() ? 'Saving...' : 'Proceed Anyway' }}
        </button>
      </div>
    </div>
  </div>
</div>
